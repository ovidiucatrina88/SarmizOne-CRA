/**
 * Helper utilities for vulnerability-enhanced risk calculations
 * Implements the FAIR-CAM methodology with vulnerability metrics integration
 */

/**
 * Calculate control reliability based on variance metrics
 * 
 * Formula: reliability = (1 - (var_freq/365))^var_duration
 * 
 * @param varFreq Variance frequency (days)
 * @param varDuration Variance duration (days)
 * @returns Reliability factor (0-1)
 */
export function calculateReliability(varFreq: number, varDuration: number): number {
  if (varFreq <= 0 || varDuration <= 0) {
    return 1; // Default to perfect reliability if no variance data
  }
  
  // Calculate reliability factor
  const reliability = Math.pow(1 - (varFreq / 365), varDuration);
  
  // Ensure reliability is within valid range (0-1)
  return Math.max(0, Math.min(1, reliability));
}

/**
 * Adjust control efficacy parameters based on reliability
 * 
 * @param efficacy Base efficacy value (0-1)
 * @param reliability Reliability factor (0-1)
 * @returns Adjusted efficacy value
 */
export function adjustEfficacyWithReliability(efficacy: number, reliability: number): number {
  return efficacy * reliability;
}

/**
 * Calculate residual risk with vulnerability-enhanced parameters
 * 
 * @param tefMin Minimum threat event frequency
 * @param tefMost Most likely threat event frequency 
 * @param tefMax Maximum threat event frequency
 * @param lmMin Minimum loss magnitude
 * @param lmMost Most likely loss magnitude
 * @param lmMax Maximum loss magnitude
 * @param eDetect Detection efficacy (0-1)
 * @param eResist Resistance efficacy (0-1)
 * @param reliability Control reliability factor (0-1)
 * @returns Object with min, avg, max residual risk values
 */
export function calculateResidualRiskWithVulnerabilityMetrics(
  tefMin: number,
  tefMost: number,
  tefMax: number,
  lmMin: number,
  lmMost: number, 
  lmMax: number,
  eDetect: number = 0.5,
  eResist: number = 0.5,
  reliability: number = 1
): { min: number, avg: number, max: number } {
  // Apply reliability adjustment to efficacy parameters
  const adjustedEDetect = adjustEfficacyWithReliability(eDetect, reliability);
  const adjustedEResist = adjustEfficacyWithReliability(eResist, reliability);
  
  // Calculate adjustment factors based on FAIR-CAM methodology
  // TEF is reduced by resistance controls
  const tefAdjustmentFactor = 1 - adjustedEResist;
  
  // LM is reduced by detection controls
  const lmAdjustmentFactor = 1 - adjustedEDetect;
  
  // Apply adjustment factors to calculate residual risk
  const residualTefMin = tefMin * tefAdjustmentFactor;
  const residualTefMost = tefMost * tefAdjustmentFactor;
  const residualTefMax = tefMax * tefAdjustmentFactor;
  
  const residualLmMin = lmMin * lmAdjustmentFactor;
  const residualLmMost = lmMost * lmAdjustmentFactor;
  const residualLmMax = lmMax * lmAdjustmentFactor;
  
  // Calculate the final residual risk values (TEF * LM)
  return {
    min: residualTefMin * residualLmMin,
    avg: residualTefMost * residualLmMost,
    max: residualTefMax * residualLmMax
  };
}