import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Skeleton } from "@/components/ui/skeleton";
import { Bug, Shield, AlertTriangle, Timer, Info } from "lucide-react";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";

interface VulnerabilityMetricsProps {
  riskId: number;
}

export function VulnerabilityMetrics({ riskId }: VulnerabilityMetricsProps) {
  const { data, isLoading, error } = useQuery({
    queryKey: [`/api/vulnerability-metrics/risk/${riskId}`],
    enabled: !!riskId,
  });

  // Define proper type for our metrics data
  type MetricsData = {
    metrics: {
      e_detect: number;
      e_resist: number;
      var_freq: number;
      var_duration: number;
      vulnerability_count: number;
    };
    vulnerabilities: any[];
  };

  // Cast data to our expected type
  const metricsData = data as MetricsData;

  if (isLoading) {
    return (
      <Card className="w-full">
        <CardHeader className="pb-2">
          <CardTitle className="text-md flex items-center gap-2">
            <Bug className="h-4 w-4" />
            Vulnerability Metrics
            <Skeleton className="h-4 w-4" />
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            <Skeleton className="h-4 w-full" />
            <Skeleton className="h-4 w-full" />
            <Skeleton className="h-4 w-full" />
            <Skeleton className="h-4 w-full" />
          </div>
        </CardContent>
      </Card>
    );
  }

  if (error) {
    return (
      <Card className="w-full bg-red-50">
        <CardHeader className="pb-2">
          <CardTitle className="text-md flex items-center gap-2">
            <AlertTriangle className="h-4 w-4 text-red-500" />
            Error Loading Vulnerability Data
          </CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-red-500">
            Could not retrieve vulnerability metrics. Please try again later.
          </p>
        </CardContent>
      </Card>
    );
  }

  // This line is not needed anymore as we're using metricsData

  // If no metrics available
  if (!metricsData?.metrics || metricsData.metrics.vulnerability_count === 0) {
    return (
      <Card className="w-full">
        <CardHeader className="pb-2">
          <CardTitle className="text-md flex items-center gap-2">
            <Bug className="h-4 w-4" />
            Vulnerability Metrics
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="p-4 text-center text-muted-foreground">
            <p>No vulnerability data available for this risk.</p>
          </div>
        </CardContent>
        <CardFooter className="pt-0 text-xs text-muted-foreground">
          <div className="flex items-center gap-1">
            <Info className="h-3 w-3" />
            <span>Link vulnerabilities to this risk to enhance calculation accuracy.</span>
          </div>
        </CardFooter>
      </Card>
    );
  }

  const metrics = metricsData.metrics;
  const vulnerabilities = metricsData.vulnerabilities || [];

  // Calculate reliability percentage based on variance metrics
  let reliability = 100;
  if (metrics.var_freq > 0 && metrics.var_duration > 0) {
    reliability = Math.round(
      Math.pow(1 - metrics.var_freq / 365, metrics.var_duration) * 100
    );
  }

  return (
    <Card className="w-full">
      <CardHeader className="pb-2">
        <CardTitle className="text-md flex items-center gap-2">
          <Bug className="h-4 w-4" />
          Vulnerability Metrics
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger>
                <Info className="h-4 w-4 text-muted-foreground" />
              </TooltipTrigger>
              <TooltipContent>
                <p className="max-w-xs text-xs">
                  These metrics are derived from {metrics.vulnerability_count} vulnerabilities
                  and influence the risk calculation parameters.
                </p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-xs flex items-center">
                  <Shield className="h-3 w-3 mr-1" />
                  Detection Efficacy
                </span>
                <span className="text-xs font-medium">
                  {Math.round(metrics.e_detect * 100)}%
                </span>
              </div>
              <Progress value={metrics.e_detect * 100} className="h-2" />
            </div>
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-xs flex items-center">
                  <Shield className="h-3 w-3 mr-1" />
                  Resistance Efficacy
                </span>
                <span className="text-xs font-medium">
                  {Math.round(metrics.e_resist * 100)}%
                </span>
              </div>
              <Progress value={metrics.e_resist * 100} className="h-2" />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-xs flex items-center">
                  <Timer className="h-3 w-3 mr-1" />
                  Variance Frequency
                </span>
                <span className="text-xs font-medium">
                  {metrics.var_freq > 0
                    ? `${metrics.var_freq} days`
                    : "No data"}
                </span>
              </div>
              <Progress
                value={metrics.var_freq > 0 ? Math.min(metrics.var_freq / 30 * 100, 100) : 0}
                className="h-2"
              />
            </div>
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-xs flex items-center">
                  <Timer className="h-3 w-3 mr-1" />
                  Control Reliability
                </span>
                <span className="text-xs font-medium">{reliability}%</span>
              </div>
              <Progress value={reliability} className="h-2" />
            </div>
          </div>

          <div className="border rounded p-2 bg-muted/30">
            <h4 className="text-xs font-medium mb-1">Vulnerability Count: {metrics.vulnerability_count}</h4>
            <div className="text-xs text-muted-foreground">
              These metrics are used to calculate the risk's resistance and detection parameters, 
              enhancing the accuracy of residual risk calculations.
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}